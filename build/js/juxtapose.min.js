/* juxtapose - v2014-06-18-21-33-52 - 2014-06-18
 * Copyright (c) 2014 Alex Duner and Northwestern University Knight Lab 
 */
(function(e,t){function i(e){this.image=new Image,this.image.src=e.src,this.label=e.label||!1,this.credit=e.credit||!1}function s(e){var t=this;this.image=new Image,this.flickrID=this.getFlickrID(e.src),this.callFlickrAPI(this.flickrID,t),this.label=e.label||!1,this.credit=e.credit||!1}function o(e,t){var n="url("+t+")";e.style.backgroundImage=n}function u(e){var t={width:e.naturalWidth,height:e.naturalHeight,aspect:function(){return this.width/this.height}};return t}function a(e){var t=e.indexOf("flickr.com/photos/");return t==-1?!1:!0}function f(e,t,n){this.selector=e;var r;this.options={animate:!0,showLabels:!0,showCredits:!0,startingPosition:"50%"};for(r in n)n[r]&&(this.options[r]=n[r]);t.length==2?(a(t[0].src)?this.imgBefore=new s(t[0]):this.imgBefore=new i(t[0]),a(t[1].src)?this.imgAfter=new s(t[1]):this.imgAfter=new i(t[1])):console.warn("The images paramater takes two Image objects.");if(!this.imgBefore.label||!this.imgAfter.label)this.options.showLabels=!1;if(!this.imgBefore.credit||!this.imgAfter.credit)this.options.showCredits=!1;this.load1=!1,this.load2=!1;var o=this;this.imgBefore.image.onload=function(){o.load1=!0,o._onLoaded()},this.imgAfter.image.onload=function(){o.load2=!0,o._onLoaded()}}function l(){sliders=[],[].map.call(e.querySelectorAll(".juxtapose"),function(e,t){var r=e,i=r.querySelectorAll("img"),s={animate:r.getAttribute("data-animate"),showLabels:r.getAttribute("data-showlabels"),showCredits:r.getAttribute("data-showcredits"),startingPosition:r.getAttribute("data-startingposition")};specificClass="juxtapose-"+t,r.classList.add(specificClass),selector="."+specificClass,r.innerHTML="",slider=new n.JXSlider(selector,[{src:i[0].src,label:i[0].getAttribute("data-label"),credit:i[0].getAttribute("data-credit")},{src:i[1].src,label:i[1].getAttribute("data-label"),credit:i[1].getAttribute("data-credit")}],s),n.sliders.push(slider)})}var n={sliders:[]},r="d90fc2d1f4acc584e08b8eaea5bf4d6c";s.prototype={getFlickrID:function(e){var t=e.indexOf("flickr.com/photos/"),n=t+"flickr.com/photos/".length,r=e.substr(n);return r.indexOf("/")==-1?null:(r.indexOf("/")==0&&(r=r.substr(1)),id=r.split("/")[1],id)},callFlickrAPI:function(e,t){var n="Large",i="https://api.flickr.com/services/rest/?method=flickr.photos.getSizes&api_key="+r+"&photo_id="+e+"&format=json&nojsoncallback=1",s=new XMLHttpRequest;s.open("GET",i,!0),s.onload=function(){if(s.status>=200&&s.status<400){data=JSON.parse(s.responseText);for(var e=0;e<data.sizes.size.length;e++)data.sizes.size[e].label==n&&(flickr_url=data.sizes.size[e].source);t.setFlickrImage(flickr_url)}else console.error("There was an error getting the picture from Flickr")},s.onerror=function(){console.error("There was an error getting the picture from Flickr")},s.send()},setFlickrImage:function(e){this.image.src=e}},f.prototype={updateSlider:function(t,n){var r,i,s=-1,o=this.slider.getBoundingClientRect(),u={top:o.top+e.body.scrollTop,left:o.left+e.body.scrollLeft},a=this.slider.offsetWidth;if(t instanceof MouseEvent||t instanceof TouchEvent){var f=t.pageX-u.left;r=f/a*100+"%",i=100-f/a*100+"%"}else typeof t=="string"&&(typeof t=="string"?s=parseInt(t):s=t,r=s+"%",i=100-s+"%");var l=f/a,c=parseInt(s);if(l>0&&l<1||c>=0&&c<=100)this.handle.classList.remove("transition"),this.rightImage.classList.remove("transition"),this.leftImage.classList.remove("transition"),this.options.animate&&n&&(this.handle.classList.add("transition"),this.leftImage.classList.add("transition"),this.rightImage.classList.add("transition")),this.handle.style.left=r,this.leftImage.style.width=r,this.rightImage.style.width=i,this.handlePosition=r},displayLabels:function(){leftDate=e.createElement("div"),leftDate.className="jx-label",leftDate.textContent=this.imgBefore.label,rightDate=e.createElement("div"),rightDate.className="jx-label",rightDate.textContent=this.imgAfter.label,this.leftImage.appendChild(leftDate),this.rightImage.appendChild(rightDate)},displayCredits:function(){credit=e.createElement("div"),credit.className="jx-credit",text="<em>Before </em>"+this.imgBefore.credit+" <em>After </em>"+this.imgAfter.credit,credit.innerHTML=text,this.wrapper.appendChild(credit)},setStartingPosition:function(e){this.options.startingPosition=e},checkImages:function(){return u(this.imgBefore.image).aspect()==u(this.imgAfter.image).aspect()?!0:!1},setWrapperDimensions:function(){ratio=u(this.imgBefore.image).aspect(),width=parseInt(getComputedStyle(this.wrapper).width),height=parseInt(getComputedStyle(this.wrapper).height),width?(height=width*(1/ratio),this.wrapper.style.height=height+"px"):height&&(width=height*ratio,this.wrapper.style.width=width+"px")},_onLoaded:function(){this.load1&&this.load2&&(this.wrapper=e.querySelector(this.selector),this.wrapper.classList.add("juxtapose"),this.wrapper.style.width=this.imgBefore.image.naturalWidth,this.setWrapperDimensions(),this.slider=e.createElement("div"),this.slider.className="jx-slider",this.wrapper.appendChild(this.slider),this.handle=e.createElement("div"),this.handle.className="jx-handle",this.rightImage=e.createElement("div"),this.rightImage.className="jx-image right",this.leftImage=e.createElement("div"),this.leftImage.className="jx-image left",this.labCredit=e.createElement("a"),this.labCredit.setAttribute("href","http://juxtapose.knightlab.com"),this.labCredit.className="jx-knightlab",this.labImage=new Image,this.labImage.src="http://blueline.knightlab.com/assets/logos/favicon.ico",this.labCredit.appendChild(this.labImage),this.labName=e.createElement("p"),this.labName.textContent="JuxtaposeJS",this.labCredit.appendChild(this.labName),this.slider.appendChild(this.handle),this.slider.appendChild(this.leftImage),this.slider.appendChild(this.rightImage),this.slider.appendChild(this.labCredit),this.leftArrow=e.createElement("div"),this.rightArrow=e.createElement("div"),this.control=e.createElement("div"),this.controller=e.createElement("div"),this.leftArrow.className="jx-arrow left",this.rightArrow.className="jx-arrow right",this.control.className="jx-control",this.controller.className="jx-controller",this.handle.appendChild(this.leftArrow),this.handle.appendChild(this.control),this.handle.appendChild(this.rightArrow),this.control.appendChild(this.controller),this._init())},_init:function(){this.checkImages()==0&&console.warn(this,"Check that the two images have the same aspect ratio for the slider to work correctly."),this.updateSlider(this.options.startingPosition,!1),o(this.leftImage,this.imgBefore.image.src),o(this.rightImage,this.imgAfter.image.src),this.options.showLabels==1&&this.displayLabels(),this.options.showCredits==1&&this.displayCredits();var n=this;t.addEventListener("resize",function(){n.setWrapperDimensions()}),this.slider.addEventListener("mousedown",function(t){t.preventDefault(),n.updateSlider(t,!0),animate=!0,this.addEventListener("mousemove",function(e){animate&&n.updateSlider(e,!1)}),e.addEventListener("mouseup",function(){animate=!1}),this.addEventListener("mouseleave",function(){animate=!1})}),this.slider.addEventListener("touchstart",function(e){e.preventDefault(),n.updateSlider(e,!0),this.addEventListener("touchmove",function(e){n.updateSlider(e,!1)})})}},n.JXSlider=f,t.juxtapose=n,l()})(document,window);